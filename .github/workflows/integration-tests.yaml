name: Integration Tests

on:
  pull_request:
    branches:
      - main

jobs:
  integration-tests:
    name: Run moog integration tests
    runs-on: ubuntu-latest
    env:
      MOOG_MPFS_HOST: "http://localhost:3000"
      MOOG_TEST_YACI_ADMIN: "http://localhost:10000"
      MOOG_GITHUB_PAT: ${{ secrets.MOOG_GITHUB_PAT }}
      MOOG_WALLET_FILE: "wallet.json"
      MOOG_TEST_REQUESTER_WALLET: "wallet.json"
      MOOG_TEST_ORACLE_WALLET: "wallet.json"
      MOOG_TEST_AGENT_WALLET: "wallet.json"
      MOOG_WAIT: 2
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4.3.0
        with:
          fetch-depth: 0

      - name: Set up Docker Compose
        uses: docker/setup-compose-action@v1 # Or hoverkraft-tech/compose-action for more options

      - name: Start mpfs on a local preprod Yaci cluster
        run: docker compose -f test-E2E/fixtures/docker-compose.yml up -d

      - name: Wait for mpfs to be ready
        run: |
          echo "Waiting for mpfs to be ready..."
          while [[ "$(curl -s "$MOOG_MPFS_HOST/tokens" | jq -r '.indexerStatus.ready')" != "true" ]]; do
              echo "Waiting for mpfs to be ready..."
              sleep 2
          done

      - uses: paolino/dev-assets/setup-nix@v0.0.1
        with:
          cachix-auth-token: "${{ secrets.CACHIX_AUTH_TOKEN }}"

      - name: Fund the wallet
        run: |
          nix shell -c moog wallet create -w "$MOOG_WALLET_FILE"
          address=$(nix shell -c moog wallet info | jq -r '.address')
          topup(){
              curl -s -X 'POST' \
                  "$MOOG_TEST_YACI_ADMIN/local-cluster/api/addresses/topup" \
                  -H 'accept: */*' \
                  -H 'Content-Type: application/json' \
                  -d '{
                  "address": "'"$address"'",
                  "adaAmount": 10000
                  }'
              }
          while true; do
              if topup | grep -q "Topup successful"; then
                  break
              fi
              echo "Retrying topup..."
              sleep 2
          done

      - name: Export agent PKH
        run: |
          owner=$(nix shell -c moog wallet info | jq -r '.owner')
          echo "MOOG_AGENT_PUBLIC_KEY_HASH=$owner" >> $GITHUB_ENV

      - name: Run integration tests
        run: nix run .#integration-tests

      - name: Tear down
        if: always()
        run: docker compose -f test-E2E/fixtures/docker-compose.yml down
