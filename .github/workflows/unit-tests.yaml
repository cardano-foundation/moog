name: Unit tests

on:
  pull_request:
    branches:
      - main

jobs:

  build-deps:
    uses: ./.github/workflows/build-deps.yaml

  unit-tests:
    needs: build-deps
    name: Run unit tests
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4.3.0
        with:
          fetch-depth: 0

      - name: Cache Haskell
        id: cache-haskell
        uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-ghc-9.8.4
          path:
            haskell-bin.tgz

      - name: Restore Haskell from cache
        run: |
          tar -xzf haskell-bin.tgz -C $HOME
          echo "PATH=$HOME/.ghcup/bin:$PATH" >> $GITHUB_ENV

      - name: Add ~/.local/lib and ~/.local/lib/pkgconfig to library paths
        run: |
          echo "LD_LIBRARY_PATH=$HOME/.local/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$HOME/.local/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV

      - name: Cache libsodium, secp256k1, blst
        uses: actions/cache@v4
        id: libs-cache
        with:
          path: |
            ~/.local
          key: ${{ runner.os }}-libs

      - name: Cache cabal store
        uses: actions/cache@v4
        id: cache-cabal
        with:
          path: |
            ~/.cache/cabal
          key: ${{ runner.os }}-cabal-${{ hashFiles('cabal.project.freeze') }}

      - name: Run tests
        run: |
          cabal test moog-unit-test
