name: CI

on:
  push:
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Cache and Install APT Packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: |
            autoconf
            automake
            build-essential
            g++
            git
            jq
            libffi-dev
            libgmp-dev
            liblmdb-dev
            libncurses-dev
            libssl-dev
            libsystemd-dev
            libtool
            make
            pkg-config
            tmux
            wget
            zlib1g-dev
          version: 1.0

      - name: Cache ghc
        id: cache-ghc-restore
        uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-ghc-9.8.4
          path: |
            ~/.ghcup
            ~/.cabal
      - name: Setup Haskell
        if: steps.cache-ghc-restore.outputs.cache-hit != 'true'
        id: haskell-setup
        uses: haskell-actions/setup@v2.8.2
        with:
          ghc-version: 9.8.4
      - name: Test cabal and ghc versions
        run: |
          ghc --version
          cabal --version
          which ghc
          which cabal
          echo ${{ steps.haskell-setup.outputs.cabal-store }}
      - name: Extend lib paths
        run: |
          LD_LIBRARY_PATH="$HOME/.local/lib:$LD_LIBRARY_PATH"
          PKG_CONFIG_PATH="$HOME/.local/lib/pkgconfig:$PKG_CONFIG_PATH"
          echo "PKG_CONFIG_PATH=$HOME/.local/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=$HOME/.local/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Set the iohknix version
        if: steps.libs-cache.outputs.cache-hit != 'true'
        run: |
          CARDANO_NODE_VERSION='10.5.1'
          IOHKNIX_VERSION=$(curl https://raw.githubusercontent.com/IntersectMBO/cardano-node/$CARDANO_NODE_VERSION/flake.lock | jq -r '.nodes.iohkNix.locked.rev')
          echo "iohk-nix version: $IOHKNIX_VERSION"
          echo "IOHKNIX_VERSION=$IOHKNIX_VERSION" >> $GITHUB_ENV
      - name: Cache libsodium, secp256k1, blst
        uses: actions/cache@v4
        id: libs-cache
        with:
          path: |
            ~/.local
          key: ${{ runner.os }}-libs-${{ hashFiles('cabal.project.freeze') }}
          restore-keys: |
            ${{ runner.os }}-libs-

      - name: Install blst
        if: steps.libs-cache.outputs.cache-hit != 'true'
        run: |
          BLST_VERSION=$(curl https://raw.githubusercontent.com/input-output-hk/iohk-nix/$IOHKNIX_VERSION/flake.lock | jq -r '.nodes.blst.original.ref')
          echo "Using blst version: ${BLST_VERSION}"
          : ${BLST_VERSION:='v0.3.11'}
          git clone --depth 1 --branch ${BLST_VERSION} https://github.com/supranational/blst
          cd blst
          prefix=$HOME/.local
          mkdir -p ${prefix}/{lib/pkgconfig,include}
          ./build.sh
          cat > libblst.pc << EOF
          exec_prefix=\${prefix}
          libdir=\${exec_prefix}/lib
          includedir=\${prefix}/include

          Name: libblst
          Description: Multilingual BLS12-381 signature library
          URL: https://github.com/supranational/blst
          Version: ${BLST_VERSION#v}
          Cflags: -I\${includedir}
          Libs: -L\${libdir} -lblst
          EOF
          cp libblst.pc ${prefix}/lib/pkgconfig/
          cp bindings/blst_aux.h bindings/blst.h bindings/blst.hpp  ${prefix}/include/
          cp libblst.a ${prefix}/lib
          chmod u=rw,go=r ${prefix}/{lib/{libblst.a,pkgconfig/libblst.pc},include/{blst.{h,hpp},blst_aux.h}}
      - name: Install libsodium fork
        if: steps.libs-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/src
          cd ~/src
          SODIUM_VERSION=$(curl https://raw.githubusercontent.com/input-output-hk/iohk-nix/$IOHKNIX_VERSION/flake.lock | jq -r '.nodes.sodium.original.rev')
          echo "Using sodium version: $SODIUM_VERSION"
          git clone https://github.com/intersectmbo/libsodium
          cd libsodium
          git checkout $SODIUM_VERSION
          ./autogen.sh
          ./configure --prefix=$HOME/.local
          make
          # make check
          make install
      - name: Install secp256k1
        if: steps.libs-cache.outputs.cache-hit != 'true'
        run: |
          SECP256K1_VERSION=$(curl https://raw.githubusercontent.com/input-output-hk/iohk-nix/$IOHKNIX_VERSION/flake.lock | jq -r '.nodes.secp256k1.original.ref')
          echo "Using secp256k1 version: ${SECP256K1_VERSION}"
          cd ~/src
          : ${SECP256K1_VERSION:='v0.3.2'}
          git clone --depth 1 --branch ${SECP256K1_VERSION} https://github.com/bitcoin-core/secp256k1
          cd secp256k1
          ./autogen.sh
          ./configure --enable-module-schnorrsig --enable-experimental --prefix=$HOME/.local
          make
          # make check
          make install

      - name: Cache Cabal store and build dir
        id: cabal-cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ steps.haskell-setup.outputs.cabal-store }}  # Dynamic store path
            dist-newstyle
          key: ${{ runner.os }}-cabal-${{ hashFiles('cabal.project.freeze') }}
          restore-keys: |
            ${{ runner.os }}-cabal-

      - name: Build project
        if: steps.cabal-cache.outputs.cache-hit != 'true'
        run: |
          run: |
            cabal update
            cabal build all --enable-tests --enable-benchmarks

    # - name: Run tests
    #   run: |

    #     cabal test moog-unit-test
